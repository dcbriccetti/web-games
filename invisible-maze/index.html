<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Invisible Player Escapes Maze</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 1em;
        }
    </style>
</head>
<body>

<h1>Invisible Maze</h1>
<p>Using the arrow keys, move the guy to the exit
while avoiding the obstacles, which appear
as you near them. They will move if you bump them. You become
invisible as soon as you move, and reappear briefly when you
hit obstacles.
<a href="https://github.com/dcbriccetti/web-games/tree/master/invisible-maze">Source code</a>
</p>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', {
    preload: preload, create: create, update: update
});

function preload() {
    game.load.image('mine', 'assets/mine.png');
    game.load.image('dude', 'assets/dude.png');
    game.load.image('door', 'assets/door.png');
}

var player;
var door;
var cursors;
var health = 100;
var healthText;
var mines;
var running = true;
var numMines = 60;

function create() {
    game.stage.backgroundColor = '303030';
    game.physics.startSystem(Phaser.Physics.P2JS);
    game.physics.p2.gravity.x = 0;
    game.physics.p2.gravity.y = 0;

    player = game.add.sprite(40, game.world.height / 2, 'dude');
    game.physics.p2.enable(player);
    player.body.collideWorldBounds = true;
    player.body.mass = 1;
    player.body.fixedRotation = true;
    player.body.onBeginContact.add(spriteContact, this);

    door = game.add.sprite(game.world.width - 12, game.world.height / 2 - 50, 'door');
    game.physics.p2.enable(door);
    door.body.mass = 10000;
    door.body.fixedRotation = true;

    mines = game.add.group();

    for (var i = 0; i < numMines; i++) {
        var newX = 20 + Math.random() * (game.world.width - 40);
        var newY = 20 + Math.random() * (game.world.height - 40);
        if (spriteDistance(player, newX, newY) > 50 && nearestMineDistance(newX, newY) > 50) {
            var mine = mines.create(newX, newY, 'mine');
            game.physics.p2.enable(mine);
            mine.body.mass = 10;
            mine.body.fixedRotation = true;
        }
    }

    healthText = game.add.text(16, 16, healthTextString(), { fontSize: '12px', fill: '#fff' });

    cursors = game.input.keyboard.createCursorKeys();
}

function spriteContact(body, shapeA, shapeB, equation) {
    if (body.sprite === door) {
        healthText.text = 'You made it!';
        running = false;
    } else { // A mine
        health = Math.max(health - 10, 0);
        if (health == 0) {
            healthText.text = 'Game over';
            running = false;
            mines.forEach(function(mine) {
                mine.alpha = 1;
            });
        } else {
            healthText.text = healthTextString();
        }
    }
    player.alpha = 1;
}

function update() {
    var moveAmt = 200;
    player.body.setZeroVelocity();

    if (running) {
        var moved = false;

        if (cursors.left.isDown) {
            player.body.moveLeft(moveAmt);
            moved = true;
        }
        if (cursors.right.isDown) {
            player.body.moveRight(moveAmt);
            moved = true;
        }
        if (cursors.up.isDown) {
            player.body.moveUp(moveAmt);
            moved = true;
        }
        if (cursors.down.isDown) {
            player.body.moveDown(moveAmt);
            moved = true;
        }

        if (moved) {
            player.alpha = 0;
        }

        mines.forEach(function(mine) {
            var ds = spriteDistance(mine, player.x, player.y);
            var thresh = 100;
            mine.alpha = 1.0 - Math.min(thresh, ds) / thresh;
        });
    }
}

function spriteDistance(sprite, x, y) {
    return distance(sprite.x, sprite.y, x, y);
}

function distance(x1, y1, x2, y2) {
    var dx = x2 - x1;
    var dx2 = dx * dx;
    var dy = y2 - y1;
    var dy2 = dy * dy;
    return Math.sqrt(dx2 + dy2);
}

function nearestMineDistance(x, y) {
    var minD = 100000;
    mines.forEach(function(mine) {
        var ds = spriteDistance(mine, x, y);
        if (ds < minD) {
            minD = ds;
        }
    });
    return minD;
}

function healthTextString() {
    return 'Health: ' + health + '%';
}
</script>

</body>
</html>